{% extends "_base.html" %}
{% import "macros.html" as macros %}

{% block header %}
<style type="text/css">
    header.main nav.top-left {
        margin-bottom: 1rem;
    }
    @media(min-width:768px) {
        header.main nav.top-left {
            float: left;
        }
        header.main .title {
            clear: both;
        }
    }

    /* Options avancées */
    .toggle:before {
        content: "↓";
    }
    .toggle.enabled:before {
        content: "↑";
    }
    #advanced {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin: 0 auto 1rem auto;
        max-width: 56rem;
    }
    #advanced > div {
        flex-basis: 26rem;
        padding: 2rem;
        border-bottom: thin solid #979797;
    }
    #advanced > div h3 {
        font-weight: 600;
    }
    #advanced div[role="group"] {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
    }
    #advanced .button {
        margin: 0 0.75rem 0.75rem 0;
        flex-basis: 10rem;
    }
    #advanced .button:last-child {
        margin-right: 0;
    }
    #advanced .button i {
        padding-right: 0.5rem;
    }
    @media(min-width:1900px) {
        #advanced {
            max-width: none;
        }
    }

    /* Table formatting */
    .table th, .table td {
        vertical-align: middle;
    }
    .table thead th {
        border: none;
        font-weight: 600;
        white-space: nowrap;
    }

    /* Sticky table header */
    tr th {
        position: sticky;
        position: -webkit-sticky;
        background: white;
        z-index: 10;
    }
    tr.headers th {
        top: 50px;  /* top nav height */
    }
    tr.filters th {
        top: calc(50px + 48.5px);  /* just below */
    }

    /* Sorting */
    .headers th {
        cursor: pointer;
    }
    .headers th.nosort {
        cursor: default;
    }
    .headers th::before {
        font-family: Font Awesome\ 5 Free;
        font-weight: 900;
        content: "\f0dc  ";  /* fa-sort */
    }
    .headers th[data-order="asc"]::before {
        content: "\f0dd  ";  /* fa-sort-down */
    }
    .headers th[data-order="desc"]::before {
        content: "\f0de  ";  /* fa-sort-up */
    }
    .headers th.nosort::before {
        content: "";
    }

    /* Filtering */
    th input.form-control {
        display: inline;
        width: 4rem;
        padding: 0 .25rem;
    }
    .bookmark input[type="submit"] {
        border:none;
        background: inherit;
    }
    tr.hidden-article, tr.hidden-avis {
        display: none;
    }

    /* Mark amendements without a response */
    td.input-required a.action {
        color: red;
    }
    .action i {
        margin-right: 0.33rem;
    }

</style>
{% endblock %}

{% block nav %}{% endblock %}

{% block top %}
    <nav class="top-left">
        <a class="button" href="{{ request.resource_url(context.parent.parent) }}">←&nbsp;&nbsp;Retourner aux lectures</a>
    </nav>
    <div class="title">
        <h2>{{ lecture.dossier_legislatif }}</h2>
        <h3>{{ lecture }}</h3>
    </div>
    <nav>
        <a class="button" href="{{ request.resource_url(context.parent, 'journal') }}">Voir le journal</a>
        {% if lecture.displayable %}
            <a class="button" href="{{ request.resource_url(context.parent, 'reponses') }}" target="_blank">
                Voir le dossier de banc
            </a>
        {% endif %}
    </nav>
{% endblock %}

{% block body %}
    <nav style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
        <a id="toggle-advanced" class="toggle button" href="#">
            Options avancées
        </a>
        <a id="toggle-filter" class="toggle button" href="#">
            Filtrer
        </a>
    </nav>

    <section id="advanced" class="d-none">
        <div>
            <h3>Importer des réponses</h3>
            <p>Importer des réponses à partir d’un fichier Excel converti en CSV <a href="https://github.com/betagouv/zam/wiki/Sp%C3%A9cification-import-r%C3%A9ponses">suivant la spécification dédiée</a>.</p>
            <form action="" enctype="multipart/form-data" method="post" id="import-form" class="">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="reponses" name="reponses" required>
                    <label class="custom-file-label" for="reponses">Fichier CSV</label>
                </div>
                <div role="group">
                    <input type="submit" name="upload" class="button" value="Importer les réponses">
                </div>
            </form>
        </div>
        <div>
            <h3>Importer une liasse XML</h3>
            <p>Importer des amendements à partir d'un fichier XML provenant
            de l’Assemblée nationale.</p>
            <form action="{{ request.resource_url(context.parent, 'import_liasse_xml') }}" enctype="multipart/form-data" method="post" id="import-liasse-xml" class="align-items-center">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="liasse" name="liasse">
                    <label class="custom-file-label" for="liasse">Fichier XML</label>
                </div>
                <div role="group">
                    <input type="submit" name="upload" class="button" value="Charger la liasse">
                </div>
            </form>
        </div>
        <div>
            <h3>Télécharger ce tableau</h3>
            <p>Télécharger le tableau affiché ci-dessous de tous les amendements déposés ainsi que de leurs réponses, par ordre de passage.</p>
            <div role="group" aria-label="Format de téléchargement">
                <a class="button" href="{{ request.resource_url(context.parent, 'download_amendements', query={'format': 'csv'}) }}">
                    <i class="fa fa-table"></i>
                    Format CSV
                </a>
                <a class="button" href="{{ request.resource_url(context.parent, 'download_amendements', query={'format': 'xlsx'}) }}">
                    <i class="fa fa-file-excel"></i>
                    Format Excel
                </a>
                <a class="button" href="{{ request.resource_url(context.parent, 'download_amendements', query={'format': 'pdf'}) }}">
                    <i class="fa fa-file-pdf"></i>
                    Format PDF
                </a>
            </div>
        </div>
        <div>
            <h3>Supprimer</h3>
            <p>Supprimer la lecture ainsi que tous les amendements et réponses associés.</p>
            <form method="post" action="{{ request.resource_url(context.parent) }}">
                <input type="submit" name="delete" class="danger button" value="Supprimer">
            </form>
        </div>
    </section>

    <table class="table" style="width:100%">
        <thead class="box">
            <tr class="headers">
                <th></th>
                <th>
                    Article
                </th>
                <th>Nº</th>
                {# <th class="nosort">Objet</th> #}
                <th>Auteur</th>
                <th>Groupe</th>
                <th>
                    Avis
                </th>
            </tr>
            <tr class="filters d-none">
                <th></th>
                <th>
                    <input id="article-filter" class="form-control form-control-sm" type="text" placeholder="Nº">
                </th>
                <th></th>
                {# <th></th> #}
                <th></th>
                <th></th>
                <th>
                    <select id="avis-filter">
                        <option value="all">Tous</option>
                        <option value="1">Avec</option>
                        <option value="0">Sans</option>
                    </select>
                </th>
            </tr>
        </thead>
        <tbody>
        {% for amendement in amendements %}
            <tr data-article="
                    {%- if amendement.article.type == 'article' -%}
                        {{ amendement.article.num }} {{ amendement.article.mult }}
                    {%- else -%}
                        {{ amendement.article.type }}
                    {%- endif -%}
                "
                data-avis="{{ 1 if amendement.gouvernemental or amendement.avis else 0 }}"
            >
                <td data-sortkey="{{ amendement.bookmarked_at or '' }}" class="bookmark">
                    <form method="post" action="{{ request.resource_url(context[amendement.num_str]) }}" id="amendement-{{ amendement.num }}">
                        {% if amendement.bookmarked_at %}
                            <input type="hidden" name="bookmark" value="0">
                            <input type="submit" name="submit" title="Cliquer pour enlever le favori" value="★">
                        {% else %}
                            <input type="hidden" name="bookmark" value="1">
                            <input type="submit" name="submit" title="Cliquer pour mettre en favori" value="☆">
                        {% endif %}
                    </form>
                </td>
                <td data-sortkey="{{ amendement.article.num }}">
                    {{ amendement.article }}
                    {% if amendement.article.titre %}
                        <br>{{ amendement.article.titre }}
                    {% endif %}
                    <a class="action" href="{{ request.resource_url(context.parent['articles'][amendement.article_url_key]) }}">
                        <i class="fas fa-edit"></i>
                    </a>
                </td>
                <td data-sortkey="{{ amendement.num }}">
                    {{ amendement.num_disp }}
                    {% if amendement.parent %}
                        (ss-amdt au {{ amendement.parent.num_disp }})
                    {% endif %}
                </td>
{#                 <td>
                    {% if amendement.observations %}
                        {{ amendement.observations | striptags | truncate(length=100, killwords=False, end='…') }}
                    {% endif %}
                </td>
 #}                <td>{{ amendement.auteur }}</td>
                <td>{{ amendement.groupe }}</td>
                <td
                    {% if not amendement.gouvernemental and not amendement.avis %}
                        class="input-required"
                    {% endif %}
                >
                    <nobr>
                        <a href="{{ request.resource_url(context[amendement.num_str], 'reponse') }}">
                        {% if amendement.avis %}
                            {{ amendement.avis }}
                        {% elif amendement.gouvernemental %}
                            &mdash;
                        {% else %}
                            Aucun
                        {% endif %}
                        </a>
                    </nobr>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
<script src="{{ request.static_url('zam_repondeur:static/tinysort/tinysort.min.js') }}"></script>
<script type="text/javascript">
    var table = document.querySelector('table')
    var tableHead = table.querySelector('thead')
    var tableHeaders = tableHead.querySelectorAll('th')

    // Options avancées
    var toggleAdvanced = document.querySelector('#toggle-advanced')
    toggleAdvanced.addEventListener('click', function(e) {
        var advanced = document.querySelector('#advanced')
        if (advanced.classList.contains('d-none')) {
            toggleAdvanced.classList.add('enabled')
            advanced.classList.remove('d-none')
        }
        else {
            toggleAdvanced.classList.remove('enabled')
            advanced.classList.add('d-none')
        }
        e.preventDefault()
    })

    // Filtrer
    var toggleFilter = document.querySelector('#toggle-filter')
    toggleFilter.addEventListener('click', function(e) {
        var filterRow = table.querySelector('tr.filters')
        if (filterRow.classList.contains('d-none')) {
            toggleFilter.classList.add('enabled')
            filterRow.classList.remove('d-none')
        }
        else {
            toggleFilter.classList.remove('enabled')
            filterRow.classList.add('d-none')
        }
        e.preventDefault()
    })

    var tableBody = table.querySelector('tbody')
    var tableLines = tableBody.querySelectorAll('tr')
    tableHead.addEventListener('click', function (e) {
        var tableHeader = e.target
        if (tableHeader.classList.contains("nosort") || tableHeader.nodeName === 'INPUT')
            return
        var tableHeaderIndex = Array.prototype.indexOf.call(tableHeaders, tableHeader)
        var isAscending = tableHeader.getAttribute('data-order') === 'asc'
        var order = isAscending ? 'desc' : 'asc'
        tableHeader.setAttribute('data-order', order)
        var options = {
            selector:'td:nth-child(' + (tableHeaderIndex + 1) + ')',
            order: order,
        }
        if (tableHeaderIndex <= 2) {
            options['data'] = 'sortkey'
        }
        tinysort(tableLines, options)
    })
    var articleFilter = table.querySelector('#article-filter')
    articleFilter.addEventListener('keyup', function (e) {
        var value = e.target.value.trim()
        ;[].slice.call(tableLines).forEach(function (line) {
            if (!value) {
                line.classList.remove('hidden-article')
                return
            }
            if (line.dataset.article.trim() === value) {
                line.classList.remove('hidden-article')
            } else {
                line.classList.add('hidden-article')
            }
        })
    })
    var avisFilter = table.querySelector('#avis-filter')
    avisFilter.addEventListener('change', function (e) {
        var value = e.target.value.trim()
        ;[].slice.call(tableLines).forEach(function (line) {
            if (value === 'all') {
                line.classList.remove('hidden-avis')
                return
            }
            if (line.dataset.avis === value) {
                line.classList.remove('hidden-avis')
            }
            else {
                line.classList.add('hidden-avis')
            }
        })
    })
    var bookmarkForms = table.querySelectorAll('.bookmark form')
    ;[].slice.call(bookmarkForms).forEach(function (bookmarkForm) {
        bookmarkForm.addEventListener('submit', function (e) {
            e.preventDefault()
            var target = e.target
            fetch(target.action, {
                method: 'POST',
                body: new FormData(target),
                credentials: 'same-origin'
            }).then(function(response) {
                var bookmarkInput = target.querySelector('[name="bookmark"]')
                var submitInput = target.querySelector('[name="submit"]')
                if (submitInput.value == '☆') {
                    submitInput.value = '★'
                    submitInput.title = 'Cliquer pour enlever le favori'
                    bookmarkInput.value = '0'
                    target.parentElement.dataset.sortkey = 1
                } else {
                    submitInput.value = '☆'
                    submitInput.title = 'Cliquer pour mettre en favori'
                    bookmarkInput.value = '1'
                    target.parentElement.dataset.sortkey = ''
                }
            })
        })
    })
</script>
{% endblock %}
