{% extends "_base.html" %}

{% block header %}
    <link rel="stylesheet" href="{{ request.static_url('zam_repondeur:static/selectr-2.4.13/selectr.min.css') }}">
    <style type="text/css">
        h2 {
            text-align: center;
            margin: 2.5rem 0 1.5rem 0;
            font-weight: 600;
        }
    </style>
{% endblock %}

{% block body %}
    <form id="add-dossier" action="{{ request.path }}" method="POST">
        <h2>Ajouter un dossier</h2>
        <p>
            <big>
                Choisir ici le dossier législatif à ajouter à Zam. La liste ci-dessous correspond aux dossiers législatifs mis à disposition par les sites Internet du Parlement. Pour sélectionner le dossier recherché, il suffit de le choisir dans la liste déroulante ou de saisir directement dans la barre de recherche un mot correspondant au nom du dossier.
            </big>
        </p>
        <div class="form-group">
            <label for="dossier">Dossier législatif</label>
            <select id="select-dossier" name="dossier" class="form-control" placeholder="Choisir un dossier législatif…" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" required>
                <option value="" selected="selected"></option>
                {% for dossier in available_dossiers %}
                    <option value="{{ dossier.slug }}">{{ dossier.titre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group save-buttons">
            <a href="{{ request.resource_url(context) }}" class="arrow-left">Retour</a>
            <input type="submit" name="submit" value="Ajouter le dossier" class="button enabled primary">
        </div>

    </form>
{% endblock %}

{% block scripts %}
<script src="{{ request.static_url('zam_repondeur:static/selectr-2.4.13/selectr.min.js') }}"></script>
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", () => {

        var util = {
            each: function(a, b, c) {
                if ("[object Object]" === Object.prototype.toString.call(a)) {
                    for (var d in a) {
                        if (Object.prototype.hasOwnProperty.call(a, d)) {
                            b.call(c, d, a[d], a);
                        }
                    }
                } else {
                    for (var e = 0, f = a.length; e < f; e++) {
                        b.call(c, e, a[e], a);
                    }
                }
            },
            createElement: function(e, a) {
                var d = document,
                    el = d.createElement(e);
                if (a && "[object Object]" === Object.prototype.toString.call(a)) {
                    var i;
                    for (i in a)
                        if (i in el) el[i] = a[i];
                        else if ("html" === i) el.innerHTML = a[i];
                        else el.setAttribute(i, a[i]);
                }
                return el;
            },
            hasClass: function(a, b) {
                if (a)
                    return a.classList ? a.classList.contains(b) : !!a.className && !!a.className.match(new RegExp("(\\s|^)" + b + "(\\s|$)"));
            },
            addClass: function(a, b) {
                if (!util.hasClass(a, b)) {
                    if (a.classList) {
                        a.classList.add(b);
                    } else {
                        a.className = a.className.trim() + " " + b;
                    }
                }
            },
            removeClass: function(a, b) {
                if (util.hasClass(a, b)) {
                    if (a.classList) {
                        a.classList.remove(b);
                    } else {
                        a.className = a.className.replace(new RegExp("(^|\\s)" + b.split(" ").join("|") + "(\\s|$)", "gi"), " ");
                    }
                }
            },
            includes: function(a, b) {
                // Poor-man fuzzyness.
                return b.split(" ").every(n => a.includes(n))
                // return a.indexOf(b) > -1;
            },
            startsWith: function(a, b) {
                return a.substr( 0, b.length ) === b;
            },
            truncate: function(el) {
                while (el.firstChild) {
                    el.removeChild(el.firstChild);
                }
            }
        };

        function appendItem(item, parent, custom) {
            if (item.parentNode) {
                if (!item.parentNode.parentNode) {
                    parent.appendChild(item.parentNode);
                }
            } else {
                parent.appendChild(item);
            }

            util.removeClass(item, "excluded");
            if (!custom) {
                // remove any <span> highlighting, without xss
                item.textContent = item.textContent;
            }
        }

        var match = function(query, option) {
            var text = option.textContent;
            var RX = new RegExp( query, "ig" );
            var result = RX.exec( text );
            if (result) {
                // #102 stop xss
                option.innerHTML = "";
                var span = document.createElement( "span" );
                span.classList.add( "selectr-match" );
                span.textContent = result[0];
                option.appendChild( document.createTextNode( text.substring( 0, result.index ) ) );
                option.appendChild( span );
                option.appendChild( document.createTextNode( text.substring( RX.lastIndex ) ) );
                return true;
            }
            return false;
        };

        Selectr.prototype.search = function( string, anchor ) {

            if ( this.navigating ) {
                return;
            }

            // we're only going to alter the DOM for "live" searches
            var live = false;
            if ( ! string ) {
                string = this.input.value;
                live = true;

                // Remove message and clear dropdown
                this.removeMessage();
                util.truncate(this.tree);
            }
            var results = [];
            var f = document.createDocumentFragment();

            string = string.trim().toLowerCase();

            if ( string.length > 0 ) {
                var compare = anchor ? util.startsWith : util.includes;

                util.each( this.options, function ( i, option ) {
                    var item = this.items[option.idx];
                    var matches = compare( option.textContent.trim().toLowerCase(), string );
                    if ( matches && !option.disabled ) {
                        results.push( { text: option.textContent, value: option.value } );
                        if ( live ) {
                            appendItem( item, f, this.customOption );
                            util.removeClass( item, "excluded" );

                            // Underline the matching results
                            if ( !this.customOption ) {
                                match( string, option );
                            }
                        }
                    } else if ( live ) {
                        util.addClass( item, "excluded" );
                    }
                }, this);

                if ( live ) {
                    // Append results
                    if ( !f.childElementCount ) {
                        if ( !this.config.taggable ) {
                            this.noResults = true;
                            this.setMessage( this.config.messages.noResults );
                        }
                    } else {
                        // Highlight top result (@binary-koan #26)
                        var prevEl = this.items[this.navIndex];
                        var firstEl = f.querySelector(".selectr-option:not(.excluded)");
                        this.noResults = false;

                        util.removeClass( prevEl, "active" );
                        this.navIndex = firstEl.idx;
                        util.addClass( firstEl, "active" );
                    }

                    this.tree.appendChild( f );
                }
            } else {
                render.call(this);
            }

            return results;
        };

        new Selectr('#select-dossier', {
            messages: {
                noResults: "Aucun résultat ne correspond à votre recherche.",
            }
        })
    })
</script>
{% endblock %}
