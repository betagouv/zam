{% extends "_base.html" %}
{% import "macros.html" as macros %}


{% block header %}
<link href="{{ request.static_url('zam_repondeur:static/balloon/balloon.css') }}" rel="stylesheet" type="text/css" />
<style type="text/css">
    .content {
        margin: 0 1rem;
    }

    /* Articles */
    #bottom-nav {
        margin-top: 5rem;
        margin-bottom: 3rem;
    }
    #articles ul {
        column-width: 12rem;
         margin-bottom: 3rem;
    }
    #articles li {
        margin-bottom: 0.75rem;
    }

    /* Options avancées */
    .toggle.with-arrow:before {
        content: "↓";
    }
    .toggle.with-arrow.enabled:before {
        content: "↑";
    }
    #advanced {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin: 0 auto 1rem auto;
        max-width: 56rem;
    }
    #advanced > div {
        flex-basis: 26rem;
        padding: 2rem;
        border-bottom: thin solid #979797;
    }
    #advanced > div h3 {
        font-weight: 600;
    }
    #advanced div[role="group"] {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
    }
    #advanced .button {
        margin: 0 0.75rem 0.75rem 0;
        flex-basis: 10rem;
    }
    #advanced .button:last-child {
        margin-right: 0;
    }
    #advanced .button i {
        padding-right: 0.5rem;
    }
    @media(min-width:1900px) {
        #advanced {
            max-width: none;
        }
    }

    /* Table formatting */
    .table th, .table td {
        vertical-align: middle;
        padding: .25rem .75rem;
    }
    .table td > span,
    .table td a {
        display: inline-block;
        line-height: 1;
    }
    .table thead th {
        border: none;
        font-weight: 600;
        white-space: nowrap;
        padding: .75rem;
    }
    .table th.avis {
        min-width: 100px;
    }
    .table tbody tr:first-child td {
        padding-top: 1rem;
    }

    /* Sticky table header */
    tr.sticky th {
        position: sticky;
        position: -webkit-sticky;
        background: white;
        z-index: 10;
        box-shadow: 0px 3px 3px 0px #CCC;
    }
        tr.headers th {
            top: 0;
        }
        tr.filters th {
            top: 2rem;
        }

    /* Sorting */
    .headers th {
        cursor: pointer;
    }
    .headers th.nosort {
        cursor: default;
    }
    .headers th::before {
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        content: "\f0dc  ";  /* fa-sort */
    }
    .headers th[data-order="asc"]::before {
        content: "\f0dd  ";  /* fa-sort-down */
    }
    .headers th[data-order="desc"]::before {
        content: "\f0de  ";  /* fa-sort-up */
    }
    .headers th.nosort::before {
        content: "";
    }

    /* Filtering */
    th input.form-control {
        display: inline;
        width: 4rem;
        padding: 0 .25rem;
    }
    tr.hidden-article,
    tr.hidden-amendement,
    tr.hidden-avis {
        display: none;
    }
    tr[data-retire-avant-seance="1"] {
        background-color: #d9d9d9;
    }

    /* Bookmarks */
    .bookmark input[type="submit"] {
        border:none;
        background: inherit;
        font-size: 1.25rem;
        cursor: pointer;
    }
    .bookmark input.bookmarked {
        color: #3167a6;
    }

    /* Links in table */
    td a, td a:hover {
        white-space: nowrap;
        text-decoration: none;
        border-bottom: thin solid #3167a6;
    }
    td a.download-pdf {
        border-bottom: none;
    }

    /* Tooltips */
    span[data-balloon].dotted {
        border-bottom: 1px dotted #3167a6;
    }
    [data-balloon] {
        cursor: auto;
    }
    [data-balloon]:after {
        font-size: 14px !important;
        padding: 1rem;
    }

    :target {
        background: #ededed66;
    }
    /* To keep under :target for priority. */
    .highlighted {
        background: #d4edda66;
    }
    nobr {
        display: block;
    }
    span.avis {
        width: 6px;
        display: block;
        height: 1.5rem;
        float: left;
        margin: 0 0.5rem 0 0;
    }
    span.avis.positive {
        background-color: #b8e986;
    }
    span.avis.sagesse {
        background-color: #6db4ff;
    }
    span.avis.negative {
        background-color: #d0021b;
    }
    span.avis.gouvernement {
        background-color: #3167a6;
    }
    span.avis.retire_avant_seance {
        background-color: #979797;
    }

    td .button {
        padding: .2rem .4rem;
        border-radius: 20px;
        font-size: 60%;
        line-height: 0;
    }
    nav.secondary div {
        font-weight: normal;
    }
</style>
{% endblock %}


{% block top %}
    <div class="title">
        <h2>{{ lecture.dossier_legislatif }}</h2>
        <h3>{{ lecture }}</h3>
    </div>
{% endblock %}

{% block secondary_header %}
    <nav class="nav secondary justify-content-between">
        <span class="nav-item">
            <a class="arrow-left" href="{{ request.resource_url(context.parent.parent) }}">Retourner aux lectures</a>
        </span>
        <div>
            {{ macros.update_informations(lecture, request.resource_url(context.parent, 'journal')) }}
        </div>
        <span class="nav-item">
            {% if lecture.displayable %}
                <a class="arrow-right" href="{{ request.resource_url(context.parent['articles']) }}" target="_blank">
                    Voir le dossier de banc
                </a>
            {% endif %}
        </span>
    </nav>
{% endblock %}

{% block body %}
<div class="content">
    {# See https://inclusive-components.design/notifications/ #}
    <div role="status" aria-live="polite"></div>

    <nav style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
        <a id="toggle-advanced" class="toggle with-arrow button" href="#">
            Options avancées
        </a>
        <a id="toggle-filter" class="toggle button" href="#">
            Filtrer
        </a>
    </nav>

    <section id="advanced" class="d-none">
        <div>
            <h3>Importer des réponses</h3>
            <p>Importer des réponses à partir d’un fichier Excel converti en CSV <a class="underlined" href="https://github.com/betagouv/zam/wiki/Sp%C3%A9cification-import-r%C3%A9ponses" target="_blank">suivant la spécification dédiée</a>.</p>
            <form action="" enctype="multipart/form-data" method="post" id="import-form" class="">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="reponses" name="reponses" required>
                    <label class="custom-file-label" for="reponses">Fichier CSV</label>
                </div>
                <div role="group">
                    <input type="submit" name="upload" class="button primary enabled centered" value="Importer les réponses">
                </div>
            </form>
        </div>
        <div>
            <h3>Télécharger ce tableau</h3>
            <p>Télécharger le tableau affiché ci-dessous de tous les amendements déposés ainsi que de leurs réponses, par ordre de passage.</p>
            <div role="group" aria-label="Format de téléchargement">
                <a class="button primary" href="{{ request.resource_url(context.parent, 'download_amendements', query={'format': 'csv'}) }}">
                    <i class="fa fa-table"></i>
                    Format CSV
                </a>
                <a class="button primary" href="{{ request.resource_url(context.parent, 'download_amendements', query={'format': 'xlsx'}) }}">
                    <i class="fa fa-file-excel"></i>
                    Format Excel
                </a>
                <a class="button primary" href="{{ request.resource_url(context.parent, 'download_amendements', query={'format': 'pdf'}) }}">
                    <i class="fa fa-file-pdf"></i>
                    Format PDF
                </a>
            </div>
        </div>
        <div>
            <h3>Importer une liasse XML</h3>
            <p>Importer des amendements à partir d'un fichier XML provenant
            de l’Assemblée nationale.</p>
            <form action="{{ request.resource_url(context.parent, 'import_liasse_xml') }}" enctype="multipart/form-data" method="post" id="import-liasse-xml" class="align-items-center">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="liasse" name="liasse">
                    <label class="custom-file-label" for="liasse">Fichier XML</label>
                </div>
                <div role="group">
                    <input type="submit" name="upload" class="button primary enabled" value="Importer la liasse">
                </div>
            </form>
        </div>
        <div>
            <h3>Supprimer</h3>
            <p>Supprimer la lecture ainsi que tous les amendements et réponses associés.</p>
            <form method="post" action="{{ request.resource_url(context.parent) }}">
                <div role="group">
                    <input type="submit" name="delete" class="danger button" value="Supprimer">
                </div>
            </form>
        </div>
    </section>

    <table class="table" style="width:100%">
        <thead class="box">
            <tr class="headers sticky">
                <th width="50px">★</th>
                <th width="150px">Article</th>
                <th width="180px">Nº</th>
                <th class="nosort">Objet</th>
                <th>Groupe (Auteur)</th>
                <th class="avis">Avis</th>
                <th class="nosort">⋯</th>
            </tr>
            <tr class="filters sticky d-none">
                <th></th>
                <th>
                    <input id="article-filter" class="form-control form-control-sm" type="text" placeholder="Nº" autocomplete="off" autocorrect="off">
                </th>
                <th>
                    <input id="amendement-filter" class="form-control form-control-sm" type="text" placeholder="Nº" autocomplete="off" autocorrect="off">
                </th>
                <th></th>
                <th></th>
                <th>
                    <select id="avis-filter">
                        <option value="">Tous</option>
                        <option value="1">Avec</option>
                        <option value="0">Sans</option>
                    </select>
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% set highlighted_amdt = request.session.pop('highlighted_amdt', None) %}
        {% for amendement in amendements %}
            <tr data-article="
                    {%- if amendement.retire_avant_seance -%}
                        {{ amendement.VERY_BIG_NUMBER }}
                    {%- elif amendement.article.type == 'article' -%}
                        {{ amendement.article.num }} {{ amendement.article.mult }}
                    {%- else -%}
                        {{ amendement.article.type }}
                    {%- endif -%}
                "
                data-amendement="{{ amendement.num }}"
                data-avis="{{ 1 if amendement.gouvernemental or amendement.avis else 0 }}"
                data-gouvernemental="{{ 1 if amendement.gouvernemental else 0 }}"
                data-retire-avant-seance="{{ 1 if amendement.retire_avant_seance else 0 }}"
                id="{{ amendement.slug }}"
                {% if amendement.slug == highlighted_amdt %}
                class="highlighted"
                {% endif %}
            >
                <td class="bookmark" data-sortkey="{{ amendement.bookmarked_at }}">
                    <form method="post" action="{{ request.resource_url(context[amendement.num_str]) }}" id="amendement-{{ amendement.num }}">
                        {% if amendement.bookmarked_at %}
                            <input type="hidden" name="bookmark" value="0">
                            <input type="submit" name="submit" title="Cliquer pour enlever le favori" value="★" class="bookmarked">
                        {% else %}
                            <input type="hidden" name="bookmark" value="1">
                            <input type="submit" name="submit" title="Cliquer pour mettre en favori" value="☆">
                        {% endif %}
                    </form>
                </td>
                <td class="article" data-sortkey="
                    {%- if amendement.retire_avant_seance -%}
                        {{ amendement.VERY_BIG_NUMBER }}
                    {%- else -%}
                        {{ amendement.article.num }}
                    {%- endif -%}">
                    <span
                    {% if amendement.article.titre %}
                        data-balloon="{{ amendement.article.titre }}" data-balloon-pos="right"
                    {% endif %}
                    >
                        {{ amendement.article }}
                    </span>
                </td>
                <td data-sortkey="
                    {%- if amendement.retire_avant_seance -%}
                        {{ amendement.VERY_BIG_NUMBER }} {# Keep at the end. #}
                    {%- else -%}
                        {{ amendement.num }}
                    {%- endif -%}">
                        {{ amendement.num_disp }}
                        {% if amendement.parent %}
                            (ss-amdt au {{ amendement.parent.num_disp }})
                        {% endif %}
                </td>
                <td>
                    {% if amendement.observations %}
                        {{ amendement.observations | striptags | truncate(length=100, killwords=False, end='…') }}
                    {% endif %}
                </td>
                <td data-sortkey="
                    {%- if amendement.retire_avant_seance -%}
                        ZZZ {# Keep at the end. #}
                    {%- elif amendement.groupe -%}
                        {{ amendement.groupe }} {{ amendement.auteur }}
                    {%- else -%}
                        {{ amendement.auteur }}
                    {%- endif -%}">
                    {% if amendement.groupe %}
                        {{ amendement.groupe }} ({{ amendement.auteur }})</td>
                    {% else %}
                        {{ amendement.auteur }}
                    {% endif %}
                <td
                    {% if not amendement.gouvernemental and not amendement.avis %}
                        class="input-required"
                    {% endif %}
                    data-sortkey="
                    {%- if amendement.retire_avant_seance -%}
                        ZZZ {# Keep at the end. #}
                    {%- elif amendement.gouvernemental -%}
                        Présentation
                    {%- elif amendement.avis -%}
                        {{ amendement.avis }}
                    {%- else -%}
                        Aucun
                    {%- endif -%}"
                >
                    <nobr
                    {% if amendement.has_reponse %}
                        data-balloon="{{ amendement.reponse | striptags | truncate(length=150, killwords=False, end='…') }}"
                        data-balloon-pos="left"
                    {% endif %}
                    >
                        {% if amendement.retire_avant_seance %}
                            <span class="avis retire_avant_seance"></span>
                        {% elif amendement.gouvernemental %}
                            <span class="avis gouvernement"></span>
                        {% elif amendement.avis %}
                            {% if amendement.sagesse %}
                                <span class="avis sagesse"></span>
                            {% elif amendement.favorable %}
                                <span class="avis positive"></span>
                            {% else %}
                                <span class="avis negative"></span>
                            {% endif %}
                        {% else %}
                            <span class="avis"></span>
                        {% endif %}
                        <a class="edit-reponse" href="{{ request.resource_url(context[amendement.num_str], 'reponse') }}">
                        {% if amendement.retire_avant_seance %}
                            Retiré avant séance
                        {% elif amendement.gouvernemental %}
                            Présentation
                        {% elif amendement.avis %}
                            {{ amendement.avis }}
                        {% else %}
                            Aucun
                        {% endif %}
                        </a>
                    </nobr>
                </td>
                <td>
                    <a class="download-pdf" href="{{ request.resource_url(context[amendement.num_str], 'download_amendement') }}">
                        <i class="far fa-file-pdf" title="Exporter en PDF"></i>
                    </a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <nav id="bottom-nav">
        <a id="toggle-articles" class="toggle primary button" href="#">
            Liste des articles&nbsp;&nbsp;&nbsp;↓
        </a>
    </nav>
    <section id="articles" class="d-none">
        <ul>
            {% for article in lecture.articles | sort %}
                {# On ne liste pas les inconnus ni les intersticiels ici #}
                {% if article.type and not article.pos %}
                    <li>
                        <a class="underlined" href="{{ request.resource_url(context.parent['articles'][article.url_key]) }}">
                            {{ article.format() }}
                        </a>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
    </section>

</div>
{% endblock %}


{% block scripts %}
<script src="{{ request.static_url('zam_repondeur:static/tinysort/tinysort.min.js') }}"></script>
<script type="text/javascript">
    ;(function notifyOnUpdates() {
        const delay = 1000 * 10 /* seconds. */
        const timestamp = Number('{{ timestamp }}')
        function displayNotificationUpdate() {
            const message =
                '<p class="alert alert-info text-center lead">De nouvelles informations sont disponibles, <a class="alert-link" href=><i class="fa fa-redo-alt"></i> rafraîchir</a> !</p>'
            document.querySelector('[role="status"]').innerHTML = message
        }
        function check() {
            const options = {
                credentials: 'include'
            }
            fetch('{{ check_url }}', options)
                .then(reponse => reponse.json())
                .then(json => {
                    if (json.modified_at !== timestamp) displayNotificationUpdate()
                })
        }
        setInterval(check, delay)
    })()

    function setupToggle(toggleSelector, targetSelector, scroll) {
        const toggle = document.querySelector(toggleSelector)
        toggle.addEventListener('click', e => {
            const target = document.querySelector(targetSelector)
            if (target.classList.contains('d-none')) {
                toggle.classList.add('enabled')
                target.classList.remove('d-none')
                if (scroll) {
                    target.scrollIntoView()
                }
            } else {
                toggle.classList.remove('enabled')
                target.classList.add('d-none')
            }
            e.preventDefault()
        })
    }
    setupToggle('#toggle-advanced', '#advanced', false)
    setupToggle('#toggle-filter', 'tr.filters', false)
    setupToggle('#toggle-articles', '#articles', true)

    /* Column sorting */
    const table = document.querySelector('table')
    const tableHead = table.querySelector('thead')
    const tableHeaders = tableHead.querySelectorAll('tr.headers th')
    const tableBody = table.querySelector('tbody')
    const tableLines = tableBody.querySelectorAll('tr')
    tableHead.addEventListener('click', e => {
        const tableHeader = e.target
        if (
            tableHeader.classList.contains('nosort') ||
            tableHeader.nodeName === 'INPUT' ||
            tableHeader.nodeName === 'OPTION' ||
            tableHeader.nodeName === 'SELECT'
        )
            return
        const isAscending = tableHeader.getAttribute('data-order') === 'asc'
        const order = isAscending ? 'desc' : 'asc'

        const colIndex = Array.prototype.indexOf.call(tableHeaders, tableHeader) + 1
        sortSpec = updateSortSpec(getSortSpecFromURL(), colIndex + order)
        replaceSortSpecInURL(sortSpec)
        sortColumn(tableHeader, colIndex, order)
    })
    function updateSortSpec(sortSpec, colSpec) {
        const updatedSpec = sortSpec
            .split('-')
            .filter(item => item !== '' && item.charAt(0) !== colSpec.charAt(0))
        updatedSpec.push(colSpec)
        return updatedSpec.join('-')
    }
    function getSortSpecFromURL() {
        return getURLParam('sort')
    }
    function replaceSortSpecInURL(sortSpec) {
        setURLParam('sort', sortSpec)
    }
    function sortColumns(sortSpec) {
        for (colSpec of sortSpec.split('-')) {
            const colIndex = parseInt(colSpec.charAt(0), 10)
            if (colIndex == 4 || colIndex > 6) {
                continue
            }
            const order = colSpec.slice(1)
            if (order !== 'asc' && order !== 'desc') {
                continue
            }
            const tableHeader = tableHead.querySelector(
                'tr:first-child th:nth-child(' + colIndex + ')'
            )
            sortColumn(tableHeader, colIndex, order)
        }
    }
    function sortColumn(tableHeader, colIndex, order) {
        tableHeader.setAttribute('data-order', order)
        const options = {
            data: 'sortkey',
            selector: 'td:nth-child(' + colIndex + ')',
            order: order
        }
        tinysort(tableLines, options)
    }
    ;(function sortColumnsFromQueryString() {
        const sortSpec = getSortSpecFromURL()
        if (sortSpec !== '') {
            sortColumns(sortSpec)
        }
    })()

    /* Column filtering */
    const articleFilter = table.querySelector('#article-filter')
    articleFilter.addEventListener('keyup', e => {
        const value = e.target.value.trim()
        filterByArticle(value)
        setURLParam('article', value)
    })
    const amendementFilter = table.querySelector('#amendement-filter')
    amendementFilter.addEventListener('keyup', e => {
        const value = e.target.value.trim()
        filterByAmendement(value)
        setURLParam('amendement', value)
    })
    const avisFilter = table.querySelector('#avis-filter')
    avisFilter.addEventListener('change', e => {
        const value = e.target.value.trim()
        filterByAvis(value)
        setURLParam('avis', value)
    })
    function filterByArticle(value) {
        filterColumn('hidden-article', line => {
            if (!value) {
                return true
            }
            return line.dataset.article.trim() === value
        })
    }
    function filterByAmendement(value) {
        filterColumn('hidden-amendement', line => {
            if (!value) {
                return true
            }
            return line.dataset.amendement.trim() === value
        })
    }
    function filterByAvis(value) {
        filterColumn('hidden-avis', line => {
            if (value === '') {
                return true
            }
            if (
                line.dataset.gouvernemental === '1' ||
                line.dataset.retireAvantSeance === '1'
            ) {
                return false
            }
            return line.dataset.avis === value
        })
    }
    function filterColumn(className, shouldShow) {
        Array.from(tableLines).forEach(line => {
            line.classList.toggle(className, !shouldShow(line))
        })
    }
    function showFilters() {
        document.querySelector('#toggle-filter').classList.add('enabled')
        document.querySelector('tr.filters').classList.remove('d-none')
    }
    ;(function filterColumnsFromQueryString() {
        const articleFilter = getURLParam('article')
        if (articleFilter !== '') {
            showFilters()
            document.querySelector('#article-filter').value = articleFilter
            filterByArticle(articleFilter)
        }
        const amendementFilter = getURLParam('amendement')
        if (amendementFilter !== '') {
            showFilters()
            document.querySelector('#amendement-filter').value = amendementFilter
            filterByAmendement(amendementFilter)
        }
        const avisFilter = getURLParam('avis')
        if (avisFilter !== '') {
            showFilters()
            document.querySelector('#avis-filter').value = avisFilter
            filterByAvis(avisFilter)
        }
    })()

    function getURLParam(name) {
        const urlParams = new URLSearchParams(window.location.search)
        return urlParams.get(name) || ''
    }
    function setURLParam(name, value) {
        if (history.replaceState) {
            const newURL = new URL(window.location.href)
            if (value !== '') {
                newURL.searchParams.set(name, value)
            } else {
                newURL.searchParams.delete(name)
            }
            window.history.replaceState({ path: newURL.href }, '', newURL.href)
        }
    }

    ;(function bookmarks() {
        const bookmarkForms = table.querySelectorAll('.bookmark form')
        Array.from(bookmarkForms).forEach(bookmarkForm => {
            bookmarkForm.addEventListener('submit', e => {
                e.preventDefault()
                const target = e.target
                const bookmarkInput = target.querySelector('[name="bookmark"]')
                const submitInput = target.querySelector('[name="submit"]')
                // Immediate visual feedback without waiting for server's response.
                if (submitInput.value == '☆') {
                    submitInput.value = '★'
                    submitInput.title = 'Cliquer pour enlever le favori'
                    submitInput.classList.add('bookmarked')
                    target.parentElement.dataset.sortkey = 1
                } else {
                    submitInput.value = '☆'
                    submitInput.title = 'Cliquer pour mettre en favori'
                    submitInput.classList.remove('bookmarked')
                    target.parentElement.dataset.sortkey = ''
                }
                const body = new FormData(target)
                fetch(target.action, {
                    method: 'POST',
                    body: body,
                    credentials: 'same-origin'
                }).then(response => {
                    // The logic might be confusing:
                    // remember we just changed the submitInput value above.
                    if (submitInput.value == '★') {
                        bookmarkInput.value = '0'
                    } else {
                        bookmarkInput.value = '1'
                    }
                })
            })
        })
    })()

    /* Taking control over native jump to avoir position under sticky headers. */
    if (location.hash) {
        /* Waiting for the next tick to supplement previous browser behavior. */
        setTimeout(() => {
            const element = document.querySelector(window.location.hash)
            const target = element.getBoundingClientRect()
            window.scrollTo({
                /* Position the highlighted element in the middle of the page. */
                top: window.scrollY + target.top - window.innerHeight / 2,
                behavior: 'smooth'
            })
        }, 1)
    }

    // Hijack edit links to inject the current page URL as a "back" query param
    const editLinks = Array.from(document.querySelectorAll('a.edit-reponse'))
    editLinks.forEach(editLink => {
        editLink.addEventListener('click', e => {
            const thisURL = new URL(window.location.href)
            const linkURL = new URL(e.target.href)
            thisURL.hash = ''
            linkURL.searchParams.set('back', thisURL.pathname + thisURL.search)
            window.location.href = linkURL.toString()
            e.preventDefault()
        })
    })
</script>
{% endblock %}
