{% extends "_base_lecture.html" %}
{% import "macros.html" as macros %}

{% block header %}
<link rel="stylesheet" type="text/css" href="{{ request.static_url('zam_repondeur:static/css/amendements.css') }}">
{% endblock %}

{% block body %}
<svg aria-hidden="true" style="position: absolute; width: 0; height: 0;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs>
    <symbol id="check" viewBox="0 0 18 14" fill="#000000">
        <polygon id="Shape" points="6 11.17 1.83 7 0.41 8.41 6 14 18 2 16.59 0.59"></polygon>
    </symbol>
 </defs>
</svg>

<h1>Index des amendements</h1>
{{ macros.update_informations(lecture, request.resource_url(context.parent, 'journal')) }}
{% set count = amendements| length %}
<div class="content"
    data-controller="amendements-filters"
    data-amendements-filters-initial-count="{{ count }}">
    <div class="options">
        <a class="toggle" href="#"
            data-action="amendements-filters#toggle"
            data-target="amendements-filters.link">
            Filtrer
        </a>
        <span data-target="amendements-filters.count">{{ count }} amendements</span>
    </div>

    <table class="table"
        data-controller="amendements-selection"
        data-target="amendements-filters.table">
        <thead class="box sticky">
            <tr class="groupActions d-none">
                <th colspan="2">
                    Actions groupées :
                </th>
                <th colspan="2">
                    <a id="transfer-amendements" href="{{ request.resource_url(context.parent, 'transfer_amendements', query={'from_index': 1}) }}" class="button primary">Transférer</a>
                </th>
                <th colspan="2">
                    <a id="export-pdf" href="{{ request.resource_url(context.parent, 'export_pdf') }}" class="button primary">Exporter en PDF</a>
                </th>
                <th></th>
            </tr>
            <tr class="headers" data-target="amendements-selection.headers">
                <th></th>
                <th>Article</th>
                <th>Nº</th>
                <th>Table</th>
                <th>Avis</th>
                <th>Réponse</th>
                <th></th>
            </tr>
            <tr class="filters d-none"
                data-target="amendements-filters.row amendements-selection.filters">
                <th>
                    <input type="checkbox" name="select-all"
                        data-action="amendements-selection#selectAll">
                </th>
                <th>
                    <input type="text" class="form-control form-control-sm" placeholder="Nº"
                        autocomplete="off" autocorrect="off"
                        data-action="keyup->amendements-filters#filterArticle"
                        data-target="amendements-filters.articleInput">
                </th>
                <th>
                    <input type="text" class="form-control form-control-sm" placeholder="Nº"
                        autocomplete="off" autocorrect="off"
                        data-action="keyup->amendements-filters#filterAmendement"
                        data-target="amendements-filters.amendementInput">
                    <input type="checkbox" id="gouvernemental"
                        data-action="amendements-filters#filterGouvernemental"
                        data-target="amendements-filters.gouvernementalCheckbox">
                    <label for="gouvernemental"
                        data-target="amendements-filters.gouvernementalLabel">
                        <abbr class="status blue" title="Gouvernemental">Gouv.</abbr>
                </th>
                <th>
                    <input type="text" class="form-control form-control-sm"
                        autocomplete="off" autocorrect="off"
                        data-action="keyup->amendements-filters#filterTable"
                        data-target="amendements-filters.tableInput">
                </th>
                <th>
                    <select
                        data-action="amendements-filters#filterAvis"
                        data-target="amendements-filters.avisSelect">
                        <option value="">Tout</option>
                        <option value="1">Avec</option>
                        <option value="0">Sans</option>
                    </select>
                </th>
                <th>
                    <select
                        data-action="amendements-filters#filterReponse"
                        data-target="amendements-filters.reponseSelect">
                        <option value="">Tout</option>
                        <option value="1">Avec</option>
                        <option value="0">Sans</option>
                    </select>
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody data-controller="amendements-backlinks" data-target="amendements-filters.tbody">
        {% set highlighted_amdt = request.session.pop('highlighted_amdt', None) %}
        {% for amendement in amendements | sort %}
            <tr data-article="
                    {%- if amendement.is_abandoned_before_seance -%}
                        {{ amendement.VERY_BIG_NUMBER }}
                    {%- elif amendement.article.type == 'article' -%}
                        {{ amendement.article.num }} {{ amendement.article.mult }}
                    {%- else -%}
                        {{ amendement.article.type }}
                    {%- endif -%}
                "
                data-order="{{ loop.index }}"
                data-amendement="{{ amendement.num }}"
                data-table="
                    {% if amendement.is_abandoned_before_seance %}
                        {% if amendement.is_withdrawn %}
                            Retiré
                        {% else %}
                            Irrecevable
                        {% endif %}
                    {% elif amendement.user_table %}
                        {{ amendement.user_table.user.name }}
                    {% endif %}"
                data-avis="{{ 1 if amendement.gouvernemental or amendement.user_content.avis else 0 }}"
                data-reponse="{{ 1 if amendement.user_content.reponse else 0 }}"
                data-gouvernemental="{{ 1 if amendement.gouvernemental else 0 }}"
                data-abandoned-before-seance="{{ 1 if amendement.is_abandoned_before_seance else 0 }}"
                id="{{ amendement.slug }}"
                {% if amendement.slug == highlighted_amdt %}
                class="highlighted"
                {% endif %}
            >
                <td>
                    <input type="checkbox" name="amendement-selected" value="{{ amendement.num }}">
                </td>
                <td class="article" data-sortkey="
                    {%- if amendement.is_abandoned_before_seance -%}
                        {{ amendement.VERY_BIG_NUMBER }}
                    {%- else -%}
                        {{ amendement.article.sort_key_as_str }}
                    {%- endif -%}">
                    {{ amendement.article }}
                </td>
                <td data-sortkey="
                    {%- if amendement.is_abandoned_before_seance -%}
                        {{ amendement.VERY_BIG_NUMBER }} {# Keep at the end. #}
                    {%- else -%}
                        {{ amendement.num }}
                    {%- endif -%}"
                    {%- if amendement.identique %}
                    class="identique
                        {% if loop.previtem is not defined or loop.previtem not in amendement.all_identiques %}
                            first
                        {% endif %}
                        {% if loop.nextitem is not defined or loop.nextitem not in amendement.all_identiques %}
                            last
                        {% endif %}
                    "
                    {% endif -%}
                >
                    {{ amendement.num_disp }}
                    {% if amendement.parent %}
                        (ss-amdt au {{ amendement.parent.num_disp }})
                    {% endif %}
                    {% if amendement.is_abandoned_before_seance %}
                        {% if amendement.is_withdrawn %}
                            <abbr class="status grey" title="Retiré">Ret.</abbr>
                        {% elif amendement.is_irrecevable %}
                            <abbr class="status grey" title="Irrecevable">Irr.</abbr>
                        {% endif %}
                    {% elif amendement.gouvernemental %}
                        <abbr class="status blue" title="Gouvernemental">Gouv.</abbr>
                    {% endif %}
                </td>
                <td data-sortkey="
                    {%- if amendement.is_abandoned_before_seance -%}
                        ZZZ {# Keep at the end. #}
                    {%- elif amendement.user_table -%}
                        {{ amendement.user_table.user.name }}
                    {%- else -%}
                        YYY {# Keep almost at the end. #}
                    {%- endif -%}">
                    {% if amendement.user_table %}
                        {{ amendement.user_table.user.name }}
                    {% endif %}
                </td>
                <td
                    {% if not amendement.gouvernemental and not amendement.user_content.avis %}
                        class="centered input-required"
                    {% else %}
                        class="centered"
                    {% endif %}
                    data-sortkey="
                    {%- if amendement.is_abandoned_before_seance -%}
                        ZZZ {# Keep at the end. #}
                    {%- elif amendement.gouvernemental -%}
                        Présentation
                    {%- elif amendement.user_content.avis -%}
                        {{ amendement.user_content.avis }}
                    {%- else -%}
                        Aucun
                    {%- endif -%}"
                >
                    <nobr>
                        {% if amendement.is_abandoned_before_seance %}
                            {# No check #}
                        {% elif amendement.gouvernemental %}
                            <abbr title="Présentation">{{ macros.svg_icon("check") }}</abbr>
                        {% elif amendement.user_content.avis %}
                            <abbr title="{{ amendement.user_content.avis }}">{{ macros.svg_icon("check") }}</abbr>
                        {% endif %}
                    </nobr>
                </td>
                <td data-sortkey="
                    {%- if amendement.is_abandoned_before_seance -%}
                        ZZZ {# Keep at the end. #}
                    {%- elif amendement.user_content.reponse -%}
                        AAA
                    {%- else -%}
                        YYY {# Keep almost at the end. #}
                    {%- endif -%}"
                    class="centered">
                    {% if amendement.user_content.reponse %}
                        {{ macros.svg_icon("check") }}
                    {% endif %}
                    {% if amendement.identique %}
                        {% set identiques = amendement.displayable_identiques %}
                        {% if not amendement.displayable_identiques_are_similaires and identiques %}
                            <span title="{% if identiques|length > 1 -%}
                                Les amendements identiques {% for amdt in identiques -%}
                                {{ amdt }}{% if loop.revindex == 2 %} et {% else %}{% if not loop.last %}, {% endif %}{% endif %}
                                {%- endfor %} n’ont pas des réponses similaires
                            {%- else -%}
                                L’amendement identique {{ identiques[0] }} n’a pas une réponse similaire
                            {%- endif %}">⚠️</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    <a class="arrow-right"
                        href="{{ request.resource_url(context[amendement.num_str], 'amendement_edit') }}"
                        data-action="amendements-backlinks#update">
                        Voir
                    </a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% if not amendements %}
        <div class="notice">
            <h3>Les amendements ne sont pas encore disponibles.</h3>
            <p>Si vous venez de créer la lecture, merci de patienter quelques instants, les amendements sont en cours de récupération, cela peut prendre quelques minutes. Une notification vous proposera de rafraîchir la page lorsque l’opération sera terminée.</p>
            {% if lecture.chambre == "an" %}
            <p>Attention : les amendements ne peuvent être récupérés qu’à l’expiration du délai de dépôt fixé pour les députés.</p>
            {% endif %}
            <p>Si vous rencontrez un problème, <a href="mailto:contact@zam.beta.gouv.fr">contactez l’équipe de développement</a> pour obtenir de l’aide.</p>
        </div>
    {% endif %}
    <div data-controller="amendements-articles">
        <nav id="bottom-nav">
            <a class="toggle primary button" href="#"
                data-action="amendements-articles#toggle">
                Liste des articles&nbsp;&nbsp;&nbsp;↓
            </a>
        </nav>
        <section id="articles" class="d-none"
            data-target="amendements-articles.list">
            <ul>
                {% for article in articles | sort %}
                    {# On ne liste pas les inconnus ni les intersticiels ici #}
                    {% if article.type and not article.pos %}
                        <li>
                            <a class="underlined" href="{{ request.resource_url(context.parent['articles'][article.url_key]) }}">
                                {{ article.format() }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </section>
    </div>
</div>
{% endblock %}

{% block check_url %}{{ check_url }}{% endblock %}
{% block check_timestamp %}{{ timestamp }}{% endblock %}
{% block check_interval %}60 {# seconds #}{% endblock %}

{% block scripts %}
    <script src="{{ request.static_url('zam_repondeur:static/tinysort/tinysort.min.js') }}"></script>
    <script src="{{ request.static_url('zam_repondeur:static/js/amendements.js') }}"></script>
    {% if amendements %}
        <script>;(() => application.register('amendements-filters', AmendementsFilters))()</script>
    {% endif %}
{% endblock %}
