{% extends "_base_lecture.html" %}

{% block header %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="{{ request.static_url('zam_repondeur:static/css/amendements.css') }}">
    <style type="text/css">
        /* Make it wide */
        main.box {
            max-width: calc(100% - 4rem);
        }

        /* Two-columns layout */
        #saisie-amendement {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-top: 2.5rem;
        }
        #saisie-amendement > section {
            flex-basis: 90ch;
            margin: 0 2rem;
            max-width: calc(90ch - 2rem);
        }
        #saisie-amendement > section.content {
            margin-right: 1rem;
        }
        #saisie-amendement > section.edit {
            margin-left: 1rem;
            padding: 2rem;
        }
        #saisie-amendement > section > div {
            margin-bottom: 2rem;
        }

        h4 {
            margin-bottom: 0.75rem;
        }
        .form-group {
            margin-bottom: 3rem;
        }
        label {
            font-weight: 600;
            margin: 2rem 0 1rem 0;
            font-size: 1.2rem;
        }
        textarea {
            height: 30vh;
        }
        div.mce-fullscreen {
            z-index: 1030;
        }
        .title {
            margin-top: 2.5rem;
        }
            .title header {
                text-align: center;
                margin-bottom: 2.5rem;
            }
                .title header h2 {
                    font-weight: 600;
                }
                .title header h3 {
                    font-size: 1.4rem;
                    font-weight: 400;
                }
                .title header h4 {
                    font-size: 1.2rem;
                    font-weight: 400;
                }
        h4 {
            margin-bottom: 0.75rem;
        }
        .form-group {
            margin-bottom: 3rem;
        }
        label {
            font-weight: 600;
            margin: 2rem 0 1rem 0;
            font-size: 1.2rem;
        }
        textarea {
            height: 30vh;
        }
        div.mce-fullscreen {
            z-index: 1030;
        }
        .title {
            margin-top: 2.5rem;
        }
            .title header {
                text-align: center;
                margin-bottom: 2.5rem;
            }
                .title header h2 {
                    font-weight: 600;
                }
                .title header h3 {
                    font-size: 1.4rem;
                    font-weight: 400;
                }
                .title header h4 {
                    font-size: 1.2rem;
                    font-weight: 400;
                }
    </style>
{% endblock %}

{% block body %}
    <h1>Saisir un nouvel amendement</h1>
    <form method="POST" action="" id="saisie-amendement" data-controller="preview">
        <section class="content box">
            <h2 class="subtitle">{{ lecture.dossier.titre }}</h2>
            <p class="subtitle">{{ lecture }}</p>
            <div class="form-group">
                <label for="subdiv">Article</label>
                <select name="subdiv" class="form-control" required
                        data-target="preview.selector" data-action="preview#update">
                    <option value="" selected disabled>Choisir dans la liste…</option>
                    {% for value, title in subdivs %}
                        <option value="{{ value }}">{{ title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div data-target="preview.contents"></div>
        </section>
        <section class="edit box">
            {% if can_select_organisation %}
                <div class="form-group">
                    <label for="organisation">Soumis par</label>
                    <select name="organisation" class="form-control" required>
                        <option value="{{ gouvernement.name }}" selected>{{ gouvernement.name }}</option>
                        {% for organisation in organisations_except_gouvernement %}
                            <option value="{{ organisation.name }}">{{ organisation.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            <div class="form-group">
                <label for="corps">Corps de l’amendement</label>
                <textarea name="corps" class="form-control editable"></textarea>
            </div>
            <div class="form-group">
                <label for="expose">Exposé des motifs</label>
                <textarea name="expose" class="form-control editable"></textarea>
            </div>
            <div class="form-group save-buttons">
                <input type="submit" name="save" class="primary button enabled" value="Enregistrer l’amendement">
            </div>
        </section>
    </form>
{% endblock %}


{% block scripts %}
    <script src="{{ request.static_url('zam_repondeur:static/tinymce-5-1-1/tinymce.min.js') }}"></script>
    <script type="text/javascript">
        tinymce.init({
            selector: 'textarea.editable',
            language: 'fr_FR',
            menubar: false,
            plugins: 'lists fullscreen paste table',
            toolbar:
                'undo redo | formatselect | bold italic removeformat | bullist numlist | table | cut copy paste | fullscreen',
            branding: false,
            elementpath: false,
            content_style: 'p, li { line-height: 1.5; margin: 1em 0; }',
            block_formats: 'Paragraphe=p;Titre=h3',
            browser_spellcheck: true,
        })
    </script>
    <script>
        class PreviewArticle extends Stimulus.Controller {
            static get targets() {
                return ['selector', 'contents']
            }

            update() {
                const subdiv = this.selectorTarget.value
                fetch(`{{ article_collection_url }}${subdiv}/preview`)
                    .then(response => response.text())
                    .then(html => {
                        this.contentsTarget.innerHTML = html
                    })
            }
        }
        ;(() => {
            application.register('preview', PreviewArticle)
        })()
    </script>
{% endblock %}
